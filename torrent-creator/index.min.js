"use strict";var DOMUtils={query:function(e){return document.querySelector(e)},queryAll:function(e){return document.querySelectorAll(e)},setText:function(e,t){for(var n=this.queryAll(e),r=0;r<n.length;r++)n[r].textContent=t},setStyle:function(e,t,n){for(var r=this.queryAll(e),a=0;a<r.length;a++)r[a].style[t]=n},setAttr:function(e,t,n){for(var r=this.queryAll(e),a=0;a<r.length;a++)t in r[a]?r[a][t]=n:r[a].setAttribute(t,n)},fadeOut:function(e,t){for(var n=this.queryAll(e),s=(t=t||300,Math.ceil(t/16)),r=0;r<n.length;r++)!function(t){var n=parseFloat(window.getComputedStyle(t).opacity)||1,r=n/s,a=0,o=setInterval(function(){var e=n-r*++a;t.style.opacity=Math.max(0,e),s<=a&&(t.style.opacity="0",t.style.display="none",clearInterval(o))},16)}(n[r])}},AppState=function(){var n={allFiles:[],singleFile:null,totalSize:0,torrentChanged:!1,trackersOverlayVisible:!1,creationFinished:!1,blockSize:16777216,torrentObject:null};return{get:function(e){return n[e]},set:function(e,t){n[e]=t},reset:function(){n.allFiles=[],n.singleFile=null,n.totalSize=0,n.torrentChanged=!1,n.torrentObject=null}}}();function folderSelected(e){const t=["Thumbs.db",".DS_Store","desktop.ini"];var n=e[0]?.webkitRelativePath?.split("/")[0];return AppState.set("allFiles",[...e].filter(e=>!t.includes(e.name))),AppState.set("totalSize",AppState.get("allFiles").reduce((e,t)=>e+t.size,0)),console.log(AppState.get("allFiles")),n}function fileSelected(e){AppState.set("singleFile",e[0]);e=AppState.get("singleFile").name;return AppState.set("totalSize",AppState.get("singleFile").size),AppState.set("allFiles",null),e}function setTorrentData(e){var t,n,r,e=e.trim();return""===e?(window.alert("Torrent name must not be empty"),!1):e.match(/[<>:\"\\\/\|\?\*]/)?(window.alert("Torrent name cannot contain any of the following characters: < > : \\ / | ? *"),!1):255<e.length?(window.alert("Torrent name cannot be longer than 255 characters"),!1):(r=AppState.get("torrentObject"),t=AppState.get("blockSize"),(r={info:n=r&&r.info||{name:"",pieces:"","piece length":0},announce:"https://daydream.dmhy.best/announce"})["creation date"]=Date.now()/1e3|0,r["created by"]="https://u2.dmhy.org/forums.php?action=viewtopic&topicid=13384",n.private=1,n.name=e,n["piece length"]=t,n.source="",AppState.set("torrentObject",r),!0)}async function createTorrentFile(e){setTorrentData(fileSelected(e))&&AppState.get("torrentObject")&&(AppState.set("torrentChanged",!1),AppState.set("creationFinished",!1),await createFromFile(AppState.get("torrentObject")))}async function createTorrentFolder(e){setTorrentData(folderSelected(e))&&AppState.get("torrentObject")&&(AppState.set("torrentChanged",!1),AppState.set("creationFinished",!1),await createFromFolder(AppState.get("torrentObject")))}async function finished(){var e=localforage.createInstance({name:"bbcodejs"}),n=(AppState.set("creationFinished",!0),AppState.get("torrentObject"));if(n&&n.info){var r=n.info.pieces;let t="";for(let e=0;e<r.length;++e)t+=String.fromCharCode(r[e]);n.info.pieces=t;var a=new Blob([new Uint8Array(Bencode.EncodeToBytes(n))],{type:"application/octet-stream"});await e.setItem("upload_autoSaveMessageTorrentBlob",a),await e.setItem("upload_autoSaveMessageTorrentName",n.info.name),DOMUtils.setStyle(".progress > div","width","100%"),DOMUtils.setText('[name="progress-total"]',"100%"),DOMUtils.setText('[name="progress-name"]',"Done."),DOMUtils.setAttr("#upload_torrent,#upload_file,#upload_folder,#torrent_create","disabled",!0),DOMUtils.setAttr("#torrent_download,#torrent_clean","disabled",!1),DOMUtils.fadeOut('[name="progress"]',3e3)}}function limitPromisePool(i,l){return new Promise((t,n)=>{const r=[];let a=0,o=0;function s(){for(;a<l&&o<i.length;)e=i[o++],a++,e().then(e=>{r.push(e),a--,s()}).catch(n);var e;0===a&&t(r)}s()})}const createFromFile=r=>new Promise(e=>{let t=r.info,o=t["piece length"],s=AppState.get("singleFile"),i=s.size,l=16777216;var n=AppState.get("blockSize");let c=l/n;n=Math.ceil(i/n);let u=new Uint8Array(20*n),d=(t.length=i,0);limitPromisePool(function(){var e=[];for(let t=0,n=0;t<s.size;t+=l,n++)e.push(()=>{return e=s.slice(t,t+l),a=n,new Promise((r,t)=>{let n=new FileReader;n.onload=e=>{let t=new Uint8Array(e.target.result),n=t.length;sha1({data:t,blockSize:o,readChunkSize:l}).then(function(e){u.set(e,a*c*20);e=(d+=n)/i*100;DOMUtils.setStyle(".progress > div","width",e+"%"),DOMUtils.setText('[name="progress-name"]',s.name),DOMUtils.setText('[name="progress-percent"]',d+" / "+i),DOMUtils.setText('[name="progress-total"]',e.toFixed(2)+"%"),t=null,r(a)})},n.onerror=e=>{n.abort(),t(e)},n.readAsArrayBuffer(e)});var e,a});return e}(),maxWorkerCount).then(async()=>{t.pieces=Array.from(u),await finished(),DOMUtils.setText('[name="progress-name"]',"Done."),e()}).catch(e=>{var t=AppState.get("singleFile");failed(t&&t.name,e)})}),createFromFolder=async U=>new Promise(async n=>{let k=AppState.get("allFiles");if(k&&U.info){let e=U.info,i=e["piece length"],l=0,c=16777216,u=new Uint8Array(c),d=0,p=0;var r=AppState.get("blockSize");let h=c/r,f=0;var a=[];for(let e=0;e<k.length;++e){var o=k[e],s=o.size;f+=s,a.push({length:s,path:o.webkitRelativePath.split("/").slice(1)})}let t=Math.ceil(f/i),g=new Uint8Array(20*t),m=0,y=(e.files=a,0),w=k,A=w[0],S=0,v=A.size,b=0,O=!1;async function B(){m>=t&&(e.pieces=Array.from(g),DOMUtils.setText('[name="progress-percent"]',k.length+" / "+k.length),await finished(),n(1))}DOMUtils.setText('[name="progress-name"]',A.name),DOMUtils.setText('[name="progress-percent"]',"1 / "+k.length),DOMUtils.setText('[name="progress-total"]',"0%"),!function n(){let r,a,o,s;var e;b===maxWorkerCount?O=!0:((e=new FileReader).readAsArrayBuffer(A.slice(S,S+c)),S+=c,O=!1,e.onloadend=function(e){return new Promise(async t=>{r=new Uint8Array(e.target.result),d+r.length>=c?(a=c-d,u.set(r.subarray(0,a),d),o=u,u=new Uint8Array(c),s=p++,b++,sha1({data:o,blockSize:i,readChunkSize:c}).then(async function(e){m+=h,g.set(e,s*h*20),b--,O&&(O=!1,n()),e=(l+=c)/f*100,DOMUtils.setStyle(".progress > div","width",e+"%"),DOMUtils.setText('[name="progress-total"]',e.toFixed(2)+"%"),await B(),t()}),u.set(r.subarray(a),0),d=r.length-a):(u.set(r,d),d+=r.length),S<v?n():++y===w.length?0!==d?sha1({data:u,blockSize:i,readChunkSize:d}).then(async function(e){m+=h,g.set(e,p*h*20),await B(),t()}):(await B(),t()):(A=w[y],v=A.size,S=0,DOMUtils.setText('[name="progress-name"]',A.name),DOMUtils.setText('[name="progress-percent"]',y+1+" / "+k.length),n())})},e.onerror=function(){failed(A.name,fr.error)})}()}});function failed(e,t){e=e?"Failed to read file: "+e:"Error reading file";t&&(e+="\nReason: "+t.message+" ("+t.name+")",console.error(e),window.alert(e))}function toUTF8Array(t){var n=[];for(let e=0;e<t.length;++e){var r=t.charCodeAt(e);r<128?n.push(r):r<2048?n.push(192|r>>6,128|63&r):r<55296||57344<=r?n.push(224|r>>12,128|r>>6&63,128|63&r):(++e,r=65536+((1023&r)<<10|1023&t.charCodeAt(e)),n.push(240|r>>18,128|r>>12&63,128|r>>6&63,128|63&r))}return n}function stringByteCount(t){let n=0;for(let e=0;e<t.length;++e){var r=t.charCodeAt(e);r<128?++n:r<2048?n+=2:r<55296||57344<=r?n+=3:(++e,n+=4)}return n}function toByteArray(t){var n=[];for(let e=0;e<t.length;++e)n.push(t.charCodeAt(e));return n}class BencodeObject{encode(e){}getBencodeObject(e){if(null!=e)switch(typeof e){case"number":return new BencodeInt(e);case"string":return new BencodeString(e);case"object":return new(Array.isArray(e)?BencodeList:BencodeDict)(e)}return null}}class BencodeDict extends BencodeObject{constructor(e){for(var t in super(),this.data={},e){var n=this.getBencodeObject(e[t]);n&&(this.data[t]=n)}}encodeBinaryString(t,e){var n=e.length,r=(t.push.apply(t,toByteArray(n.toString())),t.push(":".charCodeAt(0)),toByteArray(e));for(let e=0;e<r.length;++e)t.push(r[e])}encode(t){t.push("d".charCodeAt(0));var n=Object.keys(this.data).sort();for(let e=0;e<n.length;++e){var r=n[e],a=this.data[r],o=this.getBencodeObject(r);o&&(o.encode(t),"pieces"===r&&a instanceof BencodeString?this.encodeBinaryString(t,a.value):a.encode(t))}t.push("e".charCodeAt(0))}}class BencodeList extends BencodeObject{constructor(t){super(),this.data=[];for(let e=0;e<t.length;++e){var n=this.getBencodeObject(t[e]);n&&this.data.push(n)}}encode(t){t.push("l".charCodeAt(0));for(let e=0;e<this.data.length;++e)this.data[e].encode(t);t.push("e".charCodeAt(0))}}class BencodeString extends BencodeObject{constructor(e){super(),this.value=e}encode(e){var t=stringByteCount(this.value);e.push.apply(e,toByteArray(t.toString())),e.push(":".charCodeAt(0)),e.push.apply(e,toUTF8Array(this.value))}}class BencodeInt extends BencodeObject{constructor(e){super(),this.value=e}encode(e){e.push("i".charCodeAt(0)),e.push.apply(e,toUTF8Array(this.value.toString())),e.push("e".charCodeAt(0))}}var sha1,Bencode={EncodeToBytes:function(e){var t=[];return new BencodeDict(e).encode(t),t}},maxWorkerCount=Math.min(navigator.hardwareConcurrency||1,8),WorkerManager=function(){var a=[],o=new Set,s=[],t=null,n=!1;return{init:function(e){if(t=e,n=!0,"https:"!==location.protocol&&"http:"!==location.protocol)return!1;try{for(let e=0;e<maxWorkerCount;++e)a.push(new Worker(t))}catch(e){return console.log("添加线程发生错误: "+e),!1}return!0},enqueueTask:function(e,r){if(n){let t=null,n;for(let e=0;e<a.length;++e)if(!o.has(e)){t=a[e],n=e,o.add(e);break}t?(t.postMessage(e,[e.data.buffer]),t.onmessage=function(e){var t;o.delete(n),0!==s.length&&(t=s.shift())&&this.enqueueTask(t.data,t.callback),r(e.data)}.bind(this)):s.push({data:e,callback:r})}else r(new Error("Worker manager is not active"))},cleanup:function(){n=!1;for(let e=0;e<a.length;++e)try{a[e].terminate()}catch(e){console.warn("终止 Worker 时出错:",e)}if(a=[],o.clear(),s=[],t){try{URL.revokeObjectURL(t)}catch(e){console.warn("清理 Blob URL 时出错:",e)}t=null}},isActive:function(){return n}}}();function setupSha1WithoutWorkers(){let t=!1,n=[];var e=document.createElement("script");e.src="https://userscript.kysdm.com/js/sha1.js?v=1.1",e.onload=function(){t=!0,n.forEach(function(e){return e()}),n.length=0},document.body.appendChild(e),sha1=async function(e){return await(!t&&!await new Promise(function(e){return n.push(e)})),ProcessSha1Data(e)}}(async()=>{var e=await new Promise((t,n)=>{fetch("https://userscript.kysdm.com/js/sha1.js?v=1.1",{headers:{"Content-Type":"application/javascript"},mode:"cors"}).then(e=>(e.ok||(console.error("sha1.js 下载失败"),n("Network response was not OK")),e.text())).then(e=>{window.URL=window.URL||window.webkitURL;e=new Blob([e],{type:"application/javascript"});t(URL.createObjectURL(e))}).catch(e=>{console.error("sha1.js 崩溃"),n(e)})});WorkerManager.init(e)?(document.getElementById("upload_file").disabled=!1,document.getElementById("upload_folder").disabled=!1,document.getElementById("torrent_create").disabled=!1,sha1=function(t){return new Promise(function(e){WorkerManager.enqueueTask(t,e)})},window.addEventListener("beforeunload",function(){WorkerManager.cleanup()})):(console.warn("fall back to single threaded version"),setupSha1WithoutWorkers())})();