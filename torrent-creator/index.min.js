"use strict";"crypto"in window&&crypto.subtle&&crypto.subtle.digest?(document.getElementById("upload_file").disabled=!1,document.getElementById("upload_folder").disabled=!1,document.getElementById("torrent_create").disabled=!1):window.alert("浏览器不支持 Web Crypto API，无法使用种子创建功能。");const DOMUtils={setText:(e,t)=>document.querySelectorAll(e).forEach(e=>e.textContent=t),setStyle:(e,t,r)=>document.querySelectorAll(e).forEach(e=>e.style[t]=r),setAttr:(e,t,r)=>document.querySelectorAll(e).forEach(e=>t in e?e[t]=r:e.setAttribute(t,r)),fadeOut:(e,t=300)=>{document.querySelectorAll(e).forEach(e=>{e.style.transition=`opacity ${t}ms`,e.style.opacity="0",setTimeout(()=>e.style.display="none",t)})}},AppState=(()=>{const r={allFiles:[],singleFile:null,totalSize:0,torrentChanged:!1,trackersOverlayVisible:!1,creationFinished:!1,blockSize:16777216,torrentObject:null};return{get:e=>r[e],set:(e,t)=>r[e]=t,reset:()=>{r.allFiles=[],r.singleFile=null,r.totalSize=0,r.torrentChanged=!1,r.torrentObject=null}}})(),folderSelected=e=>{const t=["Thumbs.db",".DS_Store","desktop.ini"];var r=[...e].filter(e=>!t.includes(e.name));return AppState.set("allFiles",r),AppState.set("totalSize",r.reduce((e,t)=>e+t.size,0)),console.log(r),e[0]?.webkitRelativePath?.split("/")[0]},fileSelected=e=>{e=e[0];return AppState.set("singleFile",e),AppState.set("totalSize",e.size),AppState.set("allFiles",null),e.name},setTorrentData=e=>{var t,e=e.trim();return e?e.match(/[<>:"\\\/|\?\*]/)?(window.alert("种子名称不能包含以下字符: < > : \\ / | ? *"),!1):255<e.length?(window.alert("种子名称长度不能超过 255 个字符"),!1):((t=AppState.get("torrentObject")?.info||{name:"",pieces:"","piece length":0}).private=1,t.name=e,t["piece length"]=AppState.get("blockSize"),t.source="",AppState.set("torrentObject",{info:t,announce:"https://daydream.dmhy.best/announce","creation date":Date.now()/1e3|0,"created by":"https://u2.dmhy.org/forums.php?action=viewtopic&topicid=13384"}),!0):(window.alert("种子名称不能为空"),!1)},createTorrentFile=async e=>{e=fileSelected(e);setTorrentData(e)&&AppState.get("torrentObject")&&(AppState.set("torrentChanged",!1),AppState.set("creationFinished",!1),await createFromFile(AppState.get("torrentObject")))},createTorrentFolder=async e=>{e=folderSelected(e);setTorrentData(e)&&AppState.get("torrentObject")&&(AppState.set("torrentChanged",!1),AppState.set("creationFinished",!1),await createFromFolder(AppState.get("torrentObject")))},createProgressUpdater=()=>{let a=0,n=0;return{update:(e,t)=>{const r=e/t*100;e=performance.now();(100<=e-a||.5<=Math.abs(r-n)||100<=r)&&(requestAnimationFrame(()=>{DOMUtils.setStyle(".progress > div","width",r+"%"),DOMUtils.setText('[name="progress-total"]',r.toFixed(2)+"%")}),a=e,n=r)}}},finished=async()=>{var e,t=localforage.createInstance({name:"bbcodejs"}),r=(AppState.set("creationFinished",!0),AppState.get("torrentObject"));r?.info&&(e=new Blob([new Uint8Array(Bencode.EncodeToBytes(r))],{type:"application/octet-stream"}),await t.setItem("upload_autoSaveMessageTorrentBlob",e),await t.setItem("upload_autoSaveMessageTorrentName",r.info.name),DOMUtils.setStyle(".progress > div","width","100%"),DOMUtils.setText('[name="progress-total"]',"100%"),DOMUtils.setText('[name="progress-name"]',"完成"),DOMUtils.setAttr("#upload_torrent,#upload_file,#upload_folder,#torrent_create","disabled",!0),DOMUtils.setAttr("#torrent_download,#torrent_clean","disabled",!1),DOMUtils.fadeOut('[name="progress"]',3e3))},createFromFile=async e=>{var e=e.info,r=AppState.get("singleFile"),a=r.size,n=AppState.get("blockSize"),o=new Uint8Array(20*Math.ceil(a/n));e.length=a;let s=0;var i=createProgressUpdater();DOMUtils.setText('[name="progress-name"]',r.name),DOMUtils.setText('[name="progress-total"]',"0%");for(let e=0,t=0;e<a;e+=n,t++)try{const p=r.slice(e,e+n);var l=await new Promise((t,e)=>{const r=new FileReader;r.onload=e=>t(e.target.result),r.onerror=()=>{r.abort(),e(r.error)},r.readAsArrayBuffer(p)}),c=new Uint8Array(l),d=await crypto.subtle.digest("SHA-1",c);o.set(new Uint8Array(d),20*t),s+=c.length,i.update(s,a),DOMUtils.setText('[name="progress-percent"]',s+" / "+a)}catch(e){return void failed(r.name,e)}e.pieces=uint8ArrayToBinaryString(o),await finished()},createFromFolder=async e=>{try{const p=AppState.get("allFiles");if(p&&e.info){var t=e.info,n=AppState.get("blockSize");let r=0;const u=[0];t.files=p.map(e=>(r+=e.size,u.push(r),{length:e.size,path:e.webkitRelativePath.split("/").slice(1)}));var o=new Uint8Array(20*Math.ceil(r/n)),s=createProgressUpdater();DOMUtils.setText('[name="progress-name"]',"正在处理文件..."),DOMUtils.setText('[name="progress-percent"]',"0 / "+p.length),DOMUtils.setText('[name="progress-total"]',"0%");const g=t=>{for(let e=0;e<p.length;e++)if(t>=u[e]&&t<u[e+1])return{fileIndex:e,file:p[e],offsetInFile:t-u[e]};return null};let a=-1;for(let e=0,t=0;t<r;e++,t+=n){var i=Math.min(n,r-t),l=g(t),c=(l&&l.fileIndex!==a&&(DOMUtils.setText('[name="progress-name"]',l.file.name),DOMUtils.setText('[name="progress-percent"]',l.fileIndex+1+" / "+p.length),a=l.fileIndex),await(async(e,t)=>{var r=new Uint8Array(t);let a=0,n=e;for(;a<t;){var o=g(n);if(!o)break;var s=o.file.size-o.offsetInFile,i=t-a,s=Math.min(s,i);const l=o.file.slice(o.offsetInFile,o.offsetInFile+s);i=await new Promise((e,t)=>{const r=new FileReader;r.onload=()=>e(r.result),r.onerror=()=>t(r.error),r.readAsArrayBuffer(l)});r.set(new Uint8Array(i),a),a+=s,n+=s}return r})(t,i)),d=await crypto.subtle.digest("SHA-1",c);o.set(new Uint8Array(d),20*e),s.update(t+i,r)}t.pieces=uint8ArrayToBinaryString(o),DOMUtils.setText('[name="progress-percent"]',p.length+" / "+p.length),await finished()}}catch(e){failed("文件夹处理",e)}},failed=(e,t)=>{e=e?"读取文件失败: "+e:"读取文件出错";t&&(e+=`
原因: ${t.message} (${t.name})`,console.error(e),window.alert(e))},textEncoder=new TextEncoder,toUTF8Array=e=>textEncoder.encode(e),toByteArray=e=>[...e].map(e=>e.charCodeAt(0)),uint8ArrayToBinaryString=e=>String.fromCharCode.apply(null,e),getBencodeObject=e=>{var t;return e||0===e?new("number"==(t=typeof e)?BencodeInt:"string"==t?BencodeString:Array.isArray(e)?BencodeList:BencodeDict)(e):null};class BencodeDict{constructor(r){this.data={},Object.keys(r).forEach(e=>{var t=getBencodeObject(r[e]);t&&(this.data[e]=t)})}encode(r){r.push(100),Object.keys(this.data).sort().forEach(e=>{var t=this.data[e];getBencodeObject(e).encode(r),"pieces"===e&&t instanceof BencodeString?r.push(...toByteArray(t.value.length.toString()),58,...toByteArray(t.value)):t.encode(r)}),r.push(101)}}class BencodeList{constructor(e){this.data=e.map(e=>getBencodeObject(e)).filter(Boolean)}encode(t){t.push(108),this.data.forEach(e=>e.encode(t)),t.push(101)}}class BencodeString{constructor(e){this.value=e}encode(e){var t=toUTF8Array(this.value);e.push(...toByteArray(t.length.toString()),58,...t)}}class BencodeInt{constructor(e){this.value=e}encode(e){e.push(105,...toByteArray(this.value.toString()),101)}}const Bencode={EncodeToBytes:e=>{var t=[];return new BencodeDict(e).encode(t),t}};